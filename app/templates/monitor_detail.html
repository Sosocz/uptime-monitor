{% extends "base.html" %}
{% block title %}Monitor Details{% endblock %}
{% block content %}
<div class="space-y-8">
    <a href="/dashboard" class="inline-flex items-center space-x-2 text-[#6b7280] hover:text-[#1a1a1a] transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
        <span>Retour au tableau de bord</span>
    </a>

    <div class="liquid-glass p-8 fade-in" style="position: relative; z-index: 1;">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center space-x-4">
                <div id="statusDot" style="width:16px;height:16px;border-radius:50%;background:#fbbf24;box-shadow:0 0 12px #fbbf24;"></div>
                <div>
                    <h1 id="monitorName" class="text-3xl font-bold text-[#1a1a1a]">Chargement...</h1>
                    <p id="monitorUrl" class="text-[#6b7280] font-mono text-sm mt-1"></p>
                </div>
            </div>
            <span id="statusBadge" style="padding:8px 16px;border-radius:12px;font-size:14px;font-weight:600;background:#fbbf2430;color:#fbbf24;border:1px solid #fbbf2450;">UNKNOWN</span>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
            <div class="liquid-glass p-6" style="position: relative; z-index: 1;">
                <div class="text-[#1a1a1a] text-[#6b7280] text-sm mb-2 font-semibold">Interval</div>
                <div id="monitorInterval" class="text-2xl font-bold text-[#1a1a1a]">--</div>
            </div>
            <div class="liquid-glass p-6" style="position: relative; z-index: 1;">
                <div class="text-[#1a1a1a] text-[#6b7280] text-sm mb-2 font-semibold">Timeout</div>
                <div id="monitorTimeout" class="text-2xl font-bold text-[#1a1a1a]">--</div>
            </div>
            <div class="liquid-glass p-6" style="position: relative; z-index: 1;">
                <div class="text-[#1a1a1a] text-[#6b7280] text-sm mb-2 font-semibold">Last Check</div>
                <div id="lastCheck" class="text-2xl font-bold text-[#1a1a1a]">--</div>
            </div>
            <div class="liquid-glass p-6" style="position: relative; z-index: 1;">
                <div class="text-[#1a1a1a] text-[#6b7280] text-sm mb-2 font-semibold">Avg Response</div>
                <div id="avgResponse" class="text-2xl font-bold text-[#1a1a1a]">--</div>
            </div>
        </div>
    </div>

    <div class="liquid-glass p-8" style="position: relative; z-index: 1;">
        <h2 class="text-2xl font-bold mb-6 text-[#1a1a1a]">Site Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="liquid-glass p-6" style="position: relative; z-index: 1;">
                <div class="text-[#1a1a1a] text-[#6b7280] text-sm mb-2 font-semibold">IP Address</div>
                <div id="siteIp" class="text-xl font-bold text-[#1a1a1a] font-mono">--</div>
            </div>
            <div class="liquid-glass p-6" style="position: relative; z-index: 1;">
                <div class="text-[#1a1a1a] text-[#6b7280] text-sm mb-2 font-semibold">Server</div>
                <div id="siteServer" class="text-xl font-bold text-[#1a1a1a]">--</div>
            </div>
            <div class="liquid-glass p-6" style="position: relative; z-index: 1;">
                <div class="text-[#1a1a1a] text-[#6b7280] text-sm mb-2 font-semibold">Content Type</div>
                <div id="siteContentType" class="text-xl font-bold text-[#1a1a1a]">--</div>
            </div>
            <div class="liquid-glass p-6" style="position: relative; z-index: 1;">
                <div class="text-[#1a1a1a] text-[#6b7280] text-sm mb-2 font-semibold">SSL Expires</div>
                <div id="siteSslExpiry" class="text-xl font-bold text-[#1a1a1a]">--</div>
            </div>
            <div class="liquid-glass p-6" style="position: relative; z-index: 1; md:col-span-2;">
                <div class="text-[#1a1a1a] text-[#6b7280] text-sm mb-2 font-semibold">Response Headers</div>
                <div id="siteHeaders" class="text-sm text-[#1a1a1a] text-[#374151] font-mono" style="max-height: 150px; overflow-y: auto;">--</div>
            </div>
        </div>
    </div>

    <div class="liquid-glass p-8" style="position: relative; z-index: 1;">
        <h2 class="text-2xl font-bold mb-6 text-[#1a1a1a]">Recent Checks</h2>
        <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;">
                <thead>
                    <tr style="text-align:left;color:#6b7280;font-size:14px;border-bottom:1px solid #e5e7eb;">
                        <th style="padding:12px 8px;">Time</th>
                        <th style="padding:12px 8px;">Status</th>
                        <th style="padding:12px 8px;">Code</th>
                        <th style="padding:12px 8px;">Response Time</th>
                        <th style="padding:12px 8px;">Error</th>
                    </tr>
                </thead>
                <tbody id="checksTable">
                    <tr><td colspan="5" style="padding:20px;text-align:center;color:#6b7280;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var monitorId = {{ monitor_id }};
    
    if (!localStorage.getItem('token')) {
        window.location.href = '/login';
        return;
    }

    function loadMonitor() {
        fetchWithAuth('/api/monitors/' + monitorId).then(function(response) {
            if (!response.ok) {
                if (response.status === 404) {
                    alert('Monitor not found');
                    window.location.href = '/dashboard';
                }
                return null;
            }
            return response.json();
        }).then(function(monitor) {
            if (!monitor) return;
            
            document.getElementById('monitorName').textContent = monitor.name;
            document.getElementById('monitorUrl').textContent = monitor.url;
            document.getElementById('monitorInterval').textContent = monitor.interval + 's';
            document.getElementById('monitorTimeout').textContent = monitor.timeout + 's';
            
            var dot = document.getElementById('statusDot');
            var badge = document.getElementById('statusBadge');

            if (monitor.last_status === 'up') {
                dot.style.background = '#34d399';
                dot.style.boxShadow = '0 0 12px #34d399';
                badge.style.background = '#34d39930';
                badge.style.color = '#34d399';
                badge.style.border = '1px solid #34d39950';
                badge.textContent = 'ONLINE';
            } else if (monitor.last_status) {
                dot.style.background = '#f87171';
                dot.style.boxShadow = '0 0 12px #f87171';
                badge.style.background = '#f8717130';
                badge.style.color = '#f87171';
                badge.style.border = '1px solid #f8717150';
                badge.textContent = monitor.last_status.toUpperCase();
            } else {
                dot.style.background = '#fbbf24';
                dot.style.boxShadow = '0 0 12px #fbbf24';
                badge.style.background = '#fbbf2430';
                badge.style.color = '#fbbf24';
                badge.style.border = '1px solid #fbbf2450';
                badge.textContent = 'PENDING';
            }
            
            if (monitor.last_checked_at) {
                var d = new Date(monitor.last_checked_at);
                document.getElementById('lastCheck').textContent = d.toLocaleTimeString();
            }
        });
    }

    function loadChecks() {
        fetchWithAuth('/api/monitors/' + monitorId + '/checks?limit=20').then(function(response) {
            if (!response.ok) return null;
            return response.json();
        }).then(function(checks) {
            if (!checks) return;

            var tbody = document.getElementById('checksTable');

            if (checks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding:20px;text-align:center;color:#6b7280;">No checks yet</td></tr>';
                return;
            }

            // Update site information from latest check
            var latestCheck = checks[0];
            if (latestCheck) {
                document.getElementById('siteIp').textContent = latestCheck.ip_address || '--';
                document.getElementById('siteServer').textContent = latestCheck.server || '--';
                document.getElementById('siteContentType').textContent = latestCheck.content_type || '--';

                if (latestCheck.ssl_expires_at) {
                    var sslDate = new Date(latestCheck.ssl_expires_at);
                    var daysUntilExpiry = Math.floor((sslDate - new Date()) / (1000 * 60 * 60 * 24));
                    var expiryText = sslDate.toLocaleDateString();
                    var expiryColor = daysUntilExpiry < 30 ? '#ff4757' : (daysUntilExpiry < 60 ? '#ffa502' : '#00ff88');
                    document.getElementById('siteSslExpiry').innerHTML = '<span style="color:' + expiryColor + ';">' + expiryText + ' (' + daysUntilExpiry + ' days)</span>';
                } else if (latestCheck.status === 'up') {
                    document.getElementById('siteSslExpiry').textContent = 'No SSL';
                }

                if (latestCheck.response_headers) {
                    try {
                        var headers = JSON.parse(latestCheck.response_headers);
                        var headerHtml = Object.keys(headers).map(function(key) {
                            return '<div style="margin-bottom:4px;"><span style="color:#6b7280;">' + key + ':</span> ' + headers[key] + '</div>';
                        }).join('');
                        document.getElementById('siteHeaders').innerHTML = headerHtml || '--';
                    } catch(e) {
                        document.getElementById('siteHeaders').textContent = '--';
                    }
                }
            }

            var validChecks = checks.filter(function(c) { return c.response_time; });
            if (validChecks.length > 0) {
                var total = validChecks.reduce(function(sum, c) { return sum + c.response_time; }, 0);
                var avg = total / validChecks.length;
                document.getElementById('avgResponse').textContent = Math.round(avg) + 'ms';
            }

            tbody.innerHTML = checks.map(function(c) {
                var statusColor = c.status === 'up' ? '#34d399' : '#f87171';
                var d = new Date(c.checked_at);
                return '<tr style="border-bottom:1px solid #e5e7eb;">' +
                    '<td style="padding:12px 8px;font-size:14px;color:#1a1a1a;">' + d.toLocaleString() + '</td>' +
                    '<td style="padding:12px 8px;"><span style="padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;background:' + statusColor + '30;color:' + statusColor + ';border:1px solid ' + statusColor + '50;">' + c.status.toUpperCase() + '</span></td>' +
                    '<td style="padding:12px 8px;font-family:monospace;font-size:14px;color:#1a1a1a;">' + (c.status_code || '-') + '</td>' +
                    '<td style="padding:12px 8px;font-family:monospace;font-size:14px;color:#1a1a1a;">' + (c.response_time ? Math.round(c.response_time) + 'ms' : '-') + '</td>' +
                    '<td style="padding:12px 8px;font-size:14px;color:#f87171;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (c.error_message || '-') + '</td>' +
                    '</tr>';
            }).join('');
        });
    }

    loadMonitor();
    loadChecks();
    setInterval(function() { loadMonitor(); loadChecks(); }, 30000);
})();
</script>
{% endblock %}
