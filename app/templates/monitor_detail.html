{% extends "base.html" %}
{% block title %}Monitor Details{% endblock %}
{% block page_title %}Monitor{% endblock %}
{% block extra_css %}
<style>
    .monitor-header {
        display: flex;
        flex-direction: column;
        gap: 16px;
        padding: 24px;
        border-radius: 16px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
    }
    .monitor-header-top {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .monitor-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
    }
    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
    }
    .stat-card {
        padding: 16px;
        border-radius: 12px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
    }
    .chart-card {
        background: #0b1020;
        border-radius: 16px;
        padding: 20px;
        color: #e5e7eb;
        border: 1px solid #1f2937;
    }
    .chart-header {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px;
    }
    .chart-controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }
    .chart-select {
        background: #111827;
        border: 1px solid #1f2937;
        color: #e5e7eb;
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 12px;
    }
    .period-toggle {
        display: inline-flex;
        gap: 6px;
        background: #111827;
        padding: 6px;
        border-radius: 10px;
    }
    .period-toggle button {
        background: transparent;
        border: none;
        color: #9ca3af;
        padding: 6px 10px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
    }
    .period-toggle button.active {
        background: #1d4ed8;
        color: #fff;
    }
    .availability-table {
        width: 100%;
        border-collapse: collapse;
    }
    .availability-table th,
    .availability-table td {
        padding: 12px 8px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 13px;
    }
    .availability-table th {
        text-align: left;
        color: #6b7280;
    }
    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin-top: 16px;
    }
    .filter-row input {
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 13px;
    }
    .muted {
        color: #6b7280;
    }
</style>
{% endblock %}
{% block content %}
<div class="fade-in" style="display:flex;flex-direction:column;gap:24px;">
    <a href="/dashboard" class="inline-flex items-center" style="gap:8px;color:#6b7280;text-decoration:none;font-weight:600;">
        <span>← Retour au dashboard</span>
    </a>

    <div class="monitor-header">
        <div class="monitor-header-top">
            <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;justify-content:space-between;">
                <div>
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                <h1 id="monitorName" style="font-size:26px;font-weight:700;color:#111827;">Chargement…</h1>
                <span id="monitorStatus" class="status-pill" style="background:#fef3c7;color:#92400e;">
                    <span class="status-dot" style="background:#fbbf24;"></span>
                    PENDING
                </span>
                <span id="delayBadge" class="status-pill" style="display:none;background:#fee2e2;color:#b91c1c;">Checks delayed</span>
            </div>
                    <p id="monitorUrl" class="muted" style="font-size:14px;margin-top:6px;"></p>
                    <p id="monitorMeta" class="muted" style="font-size:13px;margin-top:4px;"></p>
                </div>
                <div class="monitor-actions">
                    <button class="btn btn-secondary" disabled>Send test alert (soon)</button>
                    <button class="btn btn-secondary" disabled>Pause (soon)</button>
                    <button class="btn btn-primary" disabled>Configure (soon)</button>
                </div>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="muted" style="font-size:12px;font-weight:600;">Currently up for</div>
                <div id="uptimeDuration" style="font-size:20px;font-weight:700;color:#111827;">--</div>
            </div>
            <div class="stat-card">
                <div class="muted" style="font-size:12px;font-weight:600;">Last checked</div>
                <div id="lastChecked" style="font-size:20px;font-weight:700;color:#111827;">--</div>
            </div>
            <div class="stat-card">
                <div class="muted" style="font-size:12px;font-weight:600;">Incidents (30d)</div>
                <div id="incidentCount" style="font-size:20px;font-weight:700;color:#111827;">--</div>
            </div>
            <div class="stat-card">
                <div class="muted" style="font-size:12px;font-weight:600;">Avg response</div>
                <div id="avgResponse" style="font-size:20px;font-weight:700;color:#111827;">--</div>
            </div>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
                <div>
                    <h2 style="font-size:18px;font-weight:700;">Response times</h2>
                    <p class="muted" style="font-size:13px;">Average response time by period.</p>
                </div>
                <div class="chart-controls">
                    <select id="regionSelect" class="chart-select">
                        <option value="europe">Europe</option>
                    </select>
                    <div class="period-toggle">
                        <button data-period="day" class="active">Day</button>
                        <button data-period="week">Week</button>
                        <button data-period="month">Month</button>
                    </div>
                </div>
            </div>
        </div>
        <div style="position:relative;height:280px;">
            <canvas id="responseChart"></canvas>
            <div id="chartLoader" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;color:#9ca3af;font-size:13px;background:rgba(11,16,32,0.6);border-radius:12px;">Loading...</div>
        </div>
        <div id="chartEmpty" class="muted" style="margin-top:12px;display:none;">No data yet.</div>
        <div id="chartHint" class="muted" style="margin-top:6px;font-size:12px;display:none;">Collecting more data…</div>
    </div>

    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px;">
            <h2 style="font-size:18px;font-weight:700;color:#111827;">Availability</h2>
            <span class="muted" style="font-size:13px;">Calculated from monitor checks.</span>
        </div>
        <div style="overflow-x:auto;">
            <table class="availability-table">
                <thead>
                    <tr>
                        <th>Time period</th>
                        <th>Availability</th>
                        <th>Downtime</th>
                        <th>Incidents</th>
                        <th>Longest incident</th>
                        <th>Avg incident</th>
                    </tr>
                </thead>
                <tbody id="availabilityTable">
                    <tr><td colspan="6" class="muted" style="text-align:center;padding:16px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        <div class="filter-row">
            <label class="muted" style="font-size:12px;font-weight:600;" for="fromDate">From</label>
            <input type="date" id="fromDate" name="fromDate">
            <label class="muted" style="font-size:12px;font-weight:600;" for="toDate">To</label>
            <input type="date" id="toDate" name="toDate">
            <button id="calculateBtn" class="btn btn-primary">Calculate</button>
            <span id="customResult" class="muted" style="font-size:12px;"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
    var monitorId = {{ monitor_id }};
    if (!localStorage.getItem('token')) {
        window.location.href = '/login';
        return;
    }

    var chartInstance = null;
    var currentPeriod = 'day';
    var currentPoints = [];
    var delayBadge = document.getElementById('delayBadge');
    var chartHint = document.getElementById('chartHint');
    var currentPoints = [];

    function formatDuration(minutes) {
        if (minutes === null || minutes === undefined) return '--';
        if (minutes < 60) return minutes + 'm';
        var hours = Math.floor(minutes / 60);
        var mins = Math.round(minutes % 60);
        if (hours < 24) return hours + 'h ' + mins + 'm';
        var days = Math.floor(hours / 24);
        var remHours = hours % 24;
        return days + 'd ' + remHours + 'h';
    }

    function parseTimestamp(iso) {
        if (!iso) return null;
        if (/[zZ]|[+-]\d{2}:?\d{2}$/.test(iso)) return new Date(iso);
        return new Date(iso + 'Z');
    }

    function relativeTime(iso) {
        var parsed = parseTimestamp(iso);
        if (!parsed) return '--';
        var diff = Date.now() - parsed.getTime();
        var mins = Math.floor(diff / 60000);
        if (mins < 1) return 'just now';
        if (mins < 60) return mins + 'm ago';
        var hours = Math.floor(mins / 60);
        if (hours < 24) return hours + 'h ago';
        var days = Math.floor(hours / 24);
        return days + 'd ago';
    }

    function setStatus(status) {
        var pill = document.getElementById('monitorStatus');
        var dot = pill.querySelector('.status-dot');
        if (status === 'up') {
            pill.style.background = '#dcfce7';
            pill.style.color = '#15803d';
            dot.style.background = '#22c55e';
            pill.lastChild.textContent = 'UP';
        } else if (status) {
            pill.style.background = '#fee2e2';
            pill.style.color = '#b91c1c';
            dot.style.background = '#ef4444';
            pill.lastChild.textContent = status.toUpperCase();
        } else {
            pill.style.background = '#fef3c7';
            pill.style.color = '#92400e';
            dot.style.background = '#fbbf24';
            pill.lastChild.textContent = 'PENDING';
        }
    }

    function loadMonitor() {
        fetchWithAuth('/api/monitors/' + monitorId).then(function(r) {
            if (!r) return;
            if (!r.ok) return;
            return r.json();
        }).then(function(monitor) {
            if (!monitor) return;
            document.getElementById('monitorName').textContent = monitor.name;
            document.getElementById('monitorUrl').textContent = monitor.url;
            document.getElementById('monitorMeta').textContent = 'Checked every ' + Math.round(monitor.interval / 60) + ' min';
            setStatus(monitor.last_status);
            if (monitor.last_checked_at) {
                document.getElementById('lastChecked').textContent = relativeTime(monitor.last_checked_at);
            }
            updateDelayBadge(monitor);
        });
    }

    function updateDelayBadge(monitor) {
        if (!delayBadge || !monitor || !monitor.last_checked_at) return;
        var intervalMs = (monitor.interval || 60) * 1000;
        var parsed = parseTimestamp(monitor.last_checked_at);
        if (!parsed) return;
        var elapsed = Date.now() - parsed.getTime();
        if (elapsed > intervalMs * 2) {
            delayBadge.style.display = 'inline-flex';
        } else {
            delayBadge.style.display = 'none';
        }
    }

    function loadChecks() {
        fetchWithAuth('/api/monitors/' + monitorId + '/checks?limit=50').then(function(r) {
            if (!r) return;
            return r.json();
        }).then(function(checks) {
            if (!checks) return;
            var valid = checks.filter(function(c) { return c.response_time; });
            if (valid.length > 0) {
                var total = valid.reduce(function(sum, c) { return sum + c.response_time; }, 0);
                document.getElementById('avgResponse').textContent = Math.round(total / valid.length) + 'ms';
            } else {
                document.getElementById('avgResponse').textContent = '--';
            }

            var lastDown = null;
            checks.forEach(function(c) {
                if (c.status !== 'up' && !lastDown) {
                    lastDown = c.checked_at;
                }
            });
            if (lastDown && checks.length > 0 && checks[0].status === 'up') {
                document.getElementById('uptimeDuration').textContent = relativeTime(lastDown).replace('ago', '');
            } else if (checks.length > 0 && checks[0].status === 'up') {
                document.getElementById('uptimeDuration').textContent = 'No incidents yet';
            } else {
                document.getElementById('uptimeDuration').textContent = '--';
            }
        });
    }

    function formatTooltipTimestamp(iso) {
        if (!iso) return '';
        var date = new Date(iso);
        var time = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit' });
        var dateLabel = date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        var tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
        return time + ' ' + tz + ' · ' + dateLabel;
    }

    var crosshairPlugin = {
        id: 'crosshairLine',
        afterDraw: function(chart) {
            if (chart.tooltip && chart.tooltip.getActiveElements().length) {
                var ctx = chart.ctx;
                var activePoint = chart.tooltip.getActiveElements()[0];
                var x = activePoint.element.x;
                var top = chart.chartArea.top;
                var bottom = chart.chartArea.bottom;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x, top);
                ctx.lineTo(x, bottom);
                ctx.lineWidth = 1;
                ctx.strokeStyle = 'rgba(148,163,184,0.45)';
                ctx.stroke();
                ctx.restore();
            }
        }
    };

    function renderChart(points) {
        if (typeof Chart === 'undefined') {
            document.getElementById('chartEmpty').textContent = 'Chart library failed to load.';
            document.getElementById('chartEmpty').style.display = 'block';
            return;
        }
        var ctx = document.getElementById('responseChart');
        currentPoints = points || [];
        var labels = currentPoints.map(function(p) {
            var d = new Date(p.ts);
            if (currentPeriod === 'day') return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            return d.toLocaleDateString();
        });
        var hasBreakdowns = currentPoints.some(function(p) {
            return (p && (p.name_lookup_ms !== null || p.connection_ms !== null || p.tls_ms !== null || p.transfer_ms !== null));
        });
        var totalDataset = {
            label: 'Total response time',
            data: currentPoints.map(function(p) { return p.total_ms; }),
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96,165,250,0.25)',
            borderWidth: 2,
            tension: 0.35,
            pointRadius: 0,
            fill: hasBreakdowns ? false : true
        };
        var datasets = [totalDataset];
        if (hasBreakdowns) {
            var lookupDataset = {
                label: 'Name lookup',
                data: currentPoints.map(function(p) { return p.name_lookup_ms !== null ? p.name_lookup_ms : null; }),
                borderColor: '#38bdf8',
                backgroundColor: 'rgba(56,189,248,0.6)',
                borderWidth: 1.5,
                tension: 0.35,
                pointRadius: 0,
                fill: true,
                stack: 'stack'
            };
            var connectionDataset = {
                label: 'Connection',
                data: currentPoints.map(function(p) { return p.connection_ms !== null ? p.connection_ms : null; }),
                borderColor: '#a78bfa',
                backgroundColor: 'rgba(167,139,250,0.6)',
                borderWidth: 1.5,
                tension: 0.35,
                pointRadius: 0,
                fill: true,
                stack: 'stack'
            };
            var tlsDataset = {
                label: 'TLS handshake',
                data: currentPoints.map(function(p) { return p.tls_ms !== null ? p.tls_ms : null; }),
                borderColor: '#fbbf24',
                backgroundColor: 'rgba(251,191,36,0.6)',
                borderWidth: 1.5,
                tension: 0.35,
                pointRadius: 0,
                fill: true,
                stack: 'stack'
            };
            var transferDataset = {
                label: 'Data transfer',
                data: currentPoints.map(function(p) { return p.transfer_ms !== null ? p.transfer_ms : null; }),
                borderColor: '#34d399',
                backgroundColor: 'rgba(52,211,153,0.6)',
                borderWidth: 1.5,
                tension: 0.35,
                pointRadius: 0,
                fill: true,
                stack: 'stack'
            };
            datasets = [lookupDataset, connectionDataset, tlsDataset, transferDataset];
        }

        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#e5e7eb' }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: '#0b1020',
                        borderColor: '#1f2937',
                        borderWidth: 1,
                        titleColor: '#e5e7eb',
                        bodyColor: '#e5e7eb',
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                if (!context || !context.length) return '';
                                var index = context[0].dataIndex;
                                var point = currentPoints[index];
                                return formatTooltipTimestamp(point ? point.ts : '');
                            },
                            label: function(context) {
                                var value = context.parsed.y;
                                var name = context.dataset.label || 'Total';
                                if (value === null || value === undefined) return '';
                                return value.toFixed(1) + 'ms ' + name;
                            },
                            afterBody: function(context) {
                                if (!context || !context.length) return '';
                                var index = context[0].dataIndex;
                                var point = currentPoints[index];
                                if (!point) return '';
                                var totalLine = 'Total: ' + point.total_ms.toFixed(1) + 'ms';
                                if (!hasBreakdowns) {
                                    return totalLine;
                                }
                                var lines = [totalLine];
                                if (point.transfer_ms !== null) lines.push('Data transfer: ' + point.transfer_ms.toFixed(1) + 'ms');
                                if (point.tls_ms !== null) lines.push('TLS handshake: ' + point.tls_ms.toFixed(1) + 'ms');
                                if (point.connection_ms !== null) lines.push('Connection: ' + point.connection_ms.toFixed(1) + 'ms');
                                if (point.name_lookup_ms !== null) lines.push('Name lookup: ' + point.name_lookup_ms.toFixed(1) + 'ms');
                                return lines.join('\\n');
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#9ca3af' },
                        grid: { color: 'rgba(255,255,255,0.06)' }
                    },
                    y: {
                        ticks: {
                            color: '#9ca3af',
                            callback: function(value) { return value >= 1000 ? (value / 1000).toFixed(1) + ' s' : value + ' ms'; }
                        },
                        grid: { color: 'rgba(255,255,255,0.06)' },
                        stacked: true
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            },
            plugins: [crosshairPlugin]
        });
    }

    function updateChartHint(points) {
        if (!chartHint) return;
        if (!points || points.length === 0) {
            chartHint.textContent = 'Collecting data…';
            chartHint.style.display = 'block';
            return;
        }
        if (points.length < 3) {
            var last = points[points.length - 1];
            if (last && last.total_ms !== null) {
                chartHint.textContent = 'Collecting more data… Last total: ' + (last.total_ms.toFixed(1)) + 'ms';
            } else {
                chartHint.textContent = 'Collecting more data…';
            }
            chartHint.style.display = 'block';
            return;
        }
        chartHint.style.display = 'none';
    }

    function loadMetrics(params) {
        var region = document.getElementById('regionSelect').value;
        var baseUrl = '/api/monitors/' + monitorId + '/metrics?region=' + region;
        var url = baseUrl + '&range=' + currentPeriod;
        if (params && params.from && params.to) {
            url = baseUrl + '&from=' + params.from + '&to=' + params.to;
        }
        document.getElementById('chartLoader').style.display = 'flex';
        fetchWithAuth(url)
            .then(function(r) {
                document.getElementById('chartLoader').style.display = 'none';
                if (!r) throw new Error('No response');
                return r.json();
            }).then(function(data) {
                if (!data) {
                    document.getElementById('chartEmpty').style.display = 'block';
                    return;
                }
                var points = data.points || [];
                if (!points || points.length === 0) {
                    document.getElementById('chartEmpty').style.display = 'block';
                    if (chartInstance) chartInstance.destroy();
                    return;
                }
                document.getElementById('chartEmpty').style.display = 'none';
                renderChart(points);
                updateChartHint(points);
            }).catch(function() {
                document.getElementById('chartLoader').style.display = 'none';
                document.getElementById('chartEmpty').style.display = 'block';
                document.getElementById('chartEmpty').textContent = 'Unable to load data.';
            });
    }

    function loadAvailability() {
        fetchWithAuth('/api/monitors/' + monitorId + '/availability').then(function(r) {
            if (!r) return;
            return r.json();
        }).then(function(data) {
            if (!data || !data.rows) return;
            var tbody = document.getElementById('availabilityTable');
            tbody.innerHTML = data.rows.map(function(row) {
                return '<tr>' +
                    '<td>' + row.label + '</td>' +
                    '<td>' + (row.availability_pct !== null ? row.availability_pct.toFixed(2) + '%' : '--') + '</td>' +
                    '<td>' + (row.downtime_minutes !== null ? formatDuration(row.downtime_minutes) : '--') + '</td>' +
                    '<td>' + row.incidents + '</td>' +
                    '<td>' + (row.longest_incident_minutes !== null ? formatDuration(row.longest_incident_minutes) : '--') + '</td>' +
                    '<td>' + (row.avg_incident_minutes !== null ? formatDuration(row.avg_incident_minutes) : '--') + '</td>' +
                    '</tr>';
            }).join('');

            var last30 = data.rows.find(function(r) { return r.label === 'Last 30 days'; });
            if (last30) {
                document.getElementById('incidentCount').textContent = last30.incidents;
            }
        });
    }

    document.querySelectorAll('.period-toggle button').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-toggle button').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentPeriod = btn.dataset.period;
            loadMetrics();
        });
    });

    document.getElementById('regionSelect').addEventListener('change', loadMetrics);

    document.getElementById('calculateBtn').addEventListener('click', function() {
        var from = document.getElementById('fromDate').value;
        var to = document.getElementById('toDate').value;
        if (!from || !to) {
            document.getElementById('customResult').textContent = 'Select both dates.';
            return;
        }
        loadMetrics({ from: from, to: to });
        fetchWithAuth('/api/monitors/' + monitorId + '/availability?from=' + from + '&to=' + to)
            .then(function(r) {
                if (!r) return;
                return r.json();
            }).then(function(data) {
                if (!data || !data.stats) return;
                var stats = data.stats;
                document.getElementById('customResult').textContent = 'Availability: ' +
                    (stats.availability_pct !== null ? stats.availability_pct.toFixed(2) + '%' : '--') +
                    ' · Downtime: ' + (stats.downtime_minutes !== null ? formatDuration(stats.downtime_minutes) : '--') +
                    ' · Incidents: ' + stats.incidents;
            });
    });

    loadMonitor();
    loadChecks();
    loadMetrics();
    loadAvailability();
    setInterval(function() { loadMonitor(); loadChecks(); }, 30000);
})();
</script>
{% endblock %}
