{% extends "base.html" %}
{% block title %}Site DNA{% endblock %}
{% block page_title %}Site DNA{% endblock %}
{% block content %}
<div id="upgradePrompt" class="card" style="text-align:center;padding:60px;">
    <div style="font-size:64px;margin-bottom:24px;">üß¨</div>
    <h1 style="font-size:32px;font-weight:700;color:#1a1a1a;margin-bottom:16px;">Fonctionnalit√© PRO</h1>
    <p style="color:#6b7280;font-size:18px;margin-bottom:32px;max-width:500px;margin-left:auto;margin-right:auto;">
        Le Site DNA est une fonctionnalit√© PRO. Analysez les patterns de comportement, d√©tectez les heures √† risque et identifiez les probl√®mes r√©currents.
    </p>
    <div style="background:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%);border-radius:12px;padding:32px;margin-bottom:32px;">
        <h2 style="font-size:24px;font-weight:700;color:#fff;margin-bottom:16px;">D√©bloquez Site DNA PRO</h2>
        <ul style="list-style:none;padding:0;margin-bottom:24px;color:#fff;text-align:left;">
            <li style="margin-bottom:12px;">‚úì Heures √† risque d√©tect√©es</li>
            <li style="margin-bottom:12px;">‚úì Jours √† risque identifi√©s</li>
            <li style="margin-bottom:12px;">‚úì Analyse de stabilit√©</li>
            <li style="margin-bottom:12px;">‚úì Pattern de comportement</li>
            <li>‚úì Alertes pr√©dictives</li>
        </ul>
        <a href="/upgrade" class="btn" style="background:#fff;color:#1e1b4b;font-weight:700;text-decoration:none;padding:16px 32px;border-radius:8px;display:inline-block;">
            Upgrade to PRO - ‚Ç¨9,99/mois
        </a>
    </div>
</div>

<div id="dnaContent" class="space-y-8 fade-in" style="display:none;">
    <div>
        <h1 style="font-size:28px;font-weight:700;color:#1a1a1a;margin-bottom:8px;">Site DNA - Pattern Detection</h1>
        <p style="color:#6b7280;">Analyze behavior patterns, detect high-risk hours, and identify recurring issues</p>
    </div>

    <div id="monitors" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px;"></div>
    <div id="noMonitors" class="card" style="text-align:center;padding:48px;display:none;">
        <p style="color:#6b7280;">No monitors found.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var token = localStorage.getItem('token');
    if (!token) window.location.href = '/login';
    
    // Check user plan and show upgrade prompt if FREE
    fetchWithAuth('/api/settings/me').then(function(r) {
        if (!r) return;
        return r.json();
    }).then(function(user) {
        if (!user) return;
        
        var isFree = user.plan === 'FREE';
        var upgradePrompt = document.getElementById('upgradePrompt');
        var dnaContent = document.getElementById('dnaContent');
        
        if (isFree) {
            upgradePrompt.style.display = 'block';
            dnaContent.style.display = 'none';
        } else {
            upgradePrompt.style.display = 'none';
            dnaContent.style.display = 'block';
            
            // Load DNA data (only for PRO)
            fetchWithAuth('/api/monitors').then(r => r ? r.json() : []).then(function(monitors) {
                if (!monitors || monitors.length === 0) {
                    document.getElementById('noMonitors').style.display = 'block';
                    return;
                } 
        
                var container = document.getElementById('monitors');
                var promises = monitors.map(function(m) {
                    return fetchWithAuth('/api/intelligence/monitors/' + m.id + '/dna')
                        .then(r => r ? r.json() : null)
                        .then(dna => ({ monitor: m, dna: dna }));
                });
        
                Promise.all(promises).then(function(results) {
                    container.innerHTML = results.map(function({monitor, dna}) {
                        if (!dna) return '';
                        return '<div class="card">' +
                            '<h3 style="font-size:16px;font-weight:600;color:#1a1a1a;margin-bottom:8px;">' + monitor.name + '</h3>' +
                            '<p style="color:#6b7280;font-size:13px;margin-bottom:16px;">' + monitor.url + '</p>' +
                            '<div style="font-size:13px;line-height:1.8;">' +
                            (dna.high_risk_hours && dna.high_risk_hours.length > 0 ?
                                '<div><strong>High-risk hours:</strong> ' + dna.high_risk_hours.join(', ') + 'h</div>' : '') +
                            (dna.high_risk_days && dna.high_risk_days.length > 0 ?
                                '<div><strong>High-risk days:</strong> ' + dna.high_risk_days.join(', ') + '</div>' : '') +
                            '<div><strong>Incidents (30d):</strong> ' + (dna.total_incidents || 0) + '</div>' +
                            '<div><strong>Stability Trend:</strong> ' + (dna.stability_trend || 'unknown') + '</div>' +
                            '</div></div>';
                    }).join('');
                });
            });
        }
    });
})();
</script>
{% endblock %}
