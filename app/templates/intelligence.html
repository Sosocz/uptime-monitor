{% extends "base.html" %}
{% block title %}Intelligence Dashboard{% endblock %}
{% block page_title %}Intelligence Dashboard{% endblock %}
{% block content %}
<div id="upgradePrompt" class="card" style="text-align:center;padding:60px;display:none;">
    <div style="font-size:64px;margin-bottom:24px;">üîí</div>
    <h1 style="font-size:32px;font-weight:700;color:#1a1a1a;margin-bottom:16px;">Fonctionnalit√© PRO</h1>
    <p style="color:#6b7280;font-size:18px;margin-bottom:32px;max-width:500px;margin-left:auto;margin-right:auto;">
        L'Intelligence Dashboard est une fonctionnalit√© PRO. Upgradez votre compte pour acc√©der aux scores de sant√©, analyse de patterns et bien plus.
    </p>
    <div style="background:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%);border-radius:12px;padding:32px;margin-bottom:32px;">
        <h2 style="font-size:24px;font-weight:700;color:#fff;margin-bottom:16px;">D√©bloquez Intelligence PRO</h2>
        <ul style="list-style:none;padding:0;margin-bottom:24px;color:#fff;text-align:left;">
            <li style="margin-bottom:12px;">‚úì Health Scores & Grades</li>
            <li style="margin-bottom:12px;">‚úì Site DNA (Pattern Analysis)</li>
            <li style="margin-bottom:12px;">‚úì Smart Views (Critical/Unstable/Stable)</li>
            <li style="margin-bottom:12px;">‚úì Root Cause Analysis</li>
            <li>‚úì Money & Time Tracking</li>
        </ul>
        <a href="/upgrade" class="btn" style="background:#fff;color:#1e1b4b;font-weight:700;text-decoration:none;padding:16px 32px;border-radius:8px;display:inline-block;">
            Upgrade to PRO - ‚Ç¨19/mois
        </a>
    </div>
</div>

<div id="intelligenceContent" class="space-y-8 fade-in" style="display:none;">
    <!-- Header -->
    <div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
            <h1 style="font-size:28px;font-weight:700;color:#1a1a1a;">Intelligence Dashboard</h1>
            <span class="badge badge-info" style="background:#2563eb;color:#fff;">PRO</span>
        </div>
        <p style="color:#6b7280;font-size:15px;">AI-powered insights, health scores, and pattern detection for your monitors</p>
    </div>

    <!-- Intelligence Modules -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;">
        <!-- Health Scores -->
        <a href="/intelligence/health" class="card" style="text-decoration:none;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='';this.style.boxShadow='';">
            <div style="font-size:48px;margin-bottom:16px;">üéØ</div>
            <h3 style="font-size:20px;font-weight:700;color:#1a1a1a;margin-bottom:8px;">Health Scores & Grades</h3>
            <p style="color:#6b7280;font-size:14px;">Monitor health grades from A+ to D. See which sites need attention at a glance.</p>
        </a>

        <!-- Site DNA -->
        <a href="/intelligence/dna" class="card" style="text-decoration:none;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='';this.style.boxShadow='';">
            <div style="font-size:48px;margin-bottom:16px;">üß¨</div>
            <h3 style="font-size:20px;font-weight:700;color:#1a1a1a;margin-bottom:8px;">Site DNA</h3>
            <p style="color:#6b7280;font-size:14px;">Detect patterns and trends. Identify high-risk hours and recurring issues.</p>
        </a>

        <!-- Smart Views -->
        <a href="/intelligence/views" class="card" style="text-decoration:none;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='';this.style.boxShadow='';">
            <div style="font-size:48px;margin-bottom:16px;">üëÅÔ∏è</div>
            <h3 style="font-size:20px;font-weight:700;color:#1a1a1a;margin-bottom:8px;">Smart Views</h3>
            <p style="color:#6b7280;font-size:14px;">Automatic grouping: Critical, Unstable, and Stable monitors. Focus on what matters.</p>
        </a>
    </div>

    <!-- Quick Stats -->
    <div class="card">
        <h3 style="font-size:18px;font-weight:700;color:#1a1a1a;margin-bottom:16px;">Intelligence Insights</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
            <div>
                <div style="color:#6b7280;font-size:13px;margin-bottom:4px;">CRITICAL MONITORS</div>
                <div style="font-size:28px;font-weight:700;color:#ef4444;" id="criticalCount">-</div>
            </div>
            <div>
                <div style="color:#6b7280;font-size:13px;margin-bottom:4px;">UNSTABLE MONITORS</div>
                <div style="font-size:28px;font-weight:700;color:#f59e0b;" id="unstableCount">-</div>
            </div>
            <div>
                <div style="color:#6b7280;font-size:13px;margin-bottom:4px;">STABLE MONITORS</div>
                <div style="font-size:28px;font-weight:700;color:#10b981;" id="stableCount">-</div>
            </div>
            <div>
                <div style="color:#6b7280;font-size:13px;margin-bottom:4px;">AVG HEALTH SCORE</div>
                <div style="font-size:28px;font-weight:700;color:#2563eb;" id="avgHealth">-</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var token = localStorage.getItem('token');
    if (!token) window.location.href = '/login';
    
    // Check user plan and show upgrade prompt if FREE
    fetchWithAuth('/api/settings/me').then(function(r) {
        if (!r) return;
        return r.json();
    }).then(function(user) {
        if (!user) return;
        
        var isFree = user.plan === 'FREE';
        var upgradePrompt = document.getElementById('upgradePrompt');
        var intelligenceContent = document.getElementById('intelligenceContent');
        
        if (isFree) {
            upgradePrompt.style.display = 'block';
            intelligenceContent.style.display = 'none';
        } else {
            upgradePrompt.style.display = 'none';
            intelligenceContent.style.display = 'block';
            
            // Load quick stats (only for PRO)
            Promise.all([
                fetchWithAuth('/api/intelligence/monitors/views/critical').then(r => r ? r.json() : []),
                fetchWithAuth('/api/intelligence/monitors/views/unstable').then(r => r ? r.json() : []),
                fetchWithAuth('/api/intelligence/monitors/views/stable').then(r => r ? r.json() : [])
            ]).then(function([critical, unstable, stable]) {
                document.getElementById('criticalCount').textContent = critical.length || 0;
                document.getElementById('unstableCount').textContent = unstable.length || 0;
                document.getElementById('stableCount').textContent = stable.length || 0;
                
                // Calculate average health
                var total = critical.length + unstable.length + stable.length;
                if (total > 0) {
                    var avgScore = ((stable.length * 95 + unstable.length * 70 + critical.length * 40) / total).toFixed(0);
                    document.getElementById('avgHealth').textContent = avgScore + '%';
                } else {
                    document.getElementById('avgHealth').textContent = 'N/A';
                }
            });
        }
    });
})();
</script>
{% endblock %}
