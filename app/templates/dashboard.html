{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="space-y-8 fade-in">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-4xl font-bold mb-2 text-white">Dashboard</h1>
            <p class="text-white text-opacity-70">Monitor your services in real-time</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <a href="/#pricing" class="liquid-btn"><span>View Plans</span></a>
            <button type="button" id="addMonitorBtn" class="liquid-btn">
                <span>
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
                    Add Monitor
                </span>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="liquid-glass liquid-glass-hover p-6" style="position: relative; z-index: 1;">
            <div class="text-white text-opacity-60 text-sm mb-2 font-semibold">Total Monitors</div>
            <div class="text-4xl font-bold text-white" id="statTotal">0</div>
        </div>
        <div class="liquid-glass liquid-glass-hover p-6" style="position: relative; z-index: 1;">
            <div class="text-white text-opacity-60 text-sm mb-2 font-semibold">Online</div>
            <div class="text-4xl font-bold text-green-400" id="statUp">0</div>
        </div>
        <div class="liquid-glass liquid-glass-hover p-6" style="position: relative; z-index: 1;">
            <div class="text-white text-opacity-60 text-sm mb-2 font-semibold">Offline</div>
            <div class="text-4xl font-bold text-red-400" id="statDown">0</div>
        </div>
        <div class="liquid-glass liquid-glass-hover p-6" style="position: relative; z-index: 1;">
            <div class="text-white text-opacity-60 text-sm mb-2 font-semibold">Your Plan</div>
            <div class="text-4xl font-bold text-white" id="statPlan">FREE</div>
        </div>
    </div>

    <div>
        <h2 class="text-2xl font-bold mb-6 text-white">Your Monitors</h2>
        <div id="monitors" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div id="noMonitors" class="liquid-glass p-16 text-center hidden" style="position: relative; z-index: 1;">
            <div class="text-5xl mb-6">ðŸ“Š</div>
            <h3 class="text-2xl font-bold mb-3 text-white">No monitors yet</h3>
            <p class="text-white text-opacity-70 mb-8 text-lg">Create your first monitor to start tracking uptime</p>
            <button type="button" id="addMonitorBtn2" class="liquid-btn"><span>+ Add Monitor</span></button>
        </div>
    </div>
</div>

<div id="createModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);z-index:9999;align-items:center;justify-content:center;">
    <div class="liquid-glass p-8" style="max-width:500px;width:90%;margin:auto;position:relative;z-index:1;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
            <h3 class="text-3xl font-bold text-white">Create Monitor</h3>
            <button type="button" id="closeModalBtn" class="liquid-glass liquid-glass-hover w-10 h-10 rounded-full flex items-center justify-center" style="cursor:pointer;border:none;">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <form id="createForm" class="space-y-5">
            <div>
                <label class="block mb-2 text-white text-opacity-90 font-semibold">Name</label>
                <input type="text" id="monitorName" required placeholder="My Website" class="liquid-input">
            </div>
            <div>
                <label class="block mb-2 text-white text-opacity-90 font-semibold">URL</label>
                <input type="url" id="monitorUrl" required placeholder="https://example.com" class="liquid-input">
            </div>
            <div>
                <label class="block mb-2 text-white text-opacity-90 font-semibold">Timeout (seconds)</label>
                <input type="number" id="monitorTimeout" value="30" min="5" max="60" required class="liquid-input">
            </div>
            <div id="createError" style="display:none;padding:14px;background:rgba(255,71,87,0.2);color:#ff6b7a;border-radius:12px;border:1px solid rgba(255,71,87,0.3);"></div>
            <div style="display:flex;gap:12px;">
                <button type="button" id="cancelBtn" class="liquid-btn" style="flex:1;"><span>Cancel</span></button>
                <button type="submit" class="liquid-btn" style="flex:1;background:rgba(102,126,234,0.3);border-color:rgba(102,126,234,0.5);"><span>Create</span></button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var authToken = localStorage.getItem('token');
    if (!authToken) {
        window.location.href = '/login';
        return;
    }

    var modal = document.getElementById('createModal');
    var addBtn = document.getElementById('addMonitorBtn');
    var addBtn2 = document.getElementById('addMonitorBtn2');
    var closeBtn = document.getElementById('closeModalBtn');
    var cancelBtn = document.getElementById('cancelBtn');
    var form = document.getElementById('createForm');

    function openModal() { modal.style.display = 'flex'; }
    function closeModal() { modal.style.display = 'none'; form.reset(); document.getElementById('createError').style.display = 'none'; }

    addBtn.addEventListener('click', openModal);
    if (addBtn2) addBtn2.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });

    function apiCall(url, options) {
        options = options || {};
        options.headers = options.headers || {};
        options.headers['Authorization'] = 'Bearer ' + authToken;
        options.headers['Content-Type'] = 'application/json';
        return fetch(url, options).then(function(response) {
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login';
                return null;
            }
            return response;
        });
    }

    function loadMonitors() {
        apiCall('/api/monitors').then(function(response) {
            if (!response) return;
            return response.json();
        }).then(function(monitors) {
            if (!monitors) return;
            document.getElementById('statTotal').textContent = monitors.length;
            document.getElementById('statUp').textContent = monitors.filter(function(m) { return m.last_status === 'up'; }).length;
            document.getElementById('statDown').textContent = monitors.filter(function(m) { return m.last_status && m.last_status !== 'up'; }).length;

            var container = document.getElementById('monitors');
            var noMonitors = document.getElementById('noMonitors');

            if (monitors.length === 0) {
                container.innerHTML = '';
                noMonitors.classList.remove('hidden');
                return;
            }

            noMonitors.classList.add('hidden');
            container.innerHTML = monitors.map(function(m) {
                var statusColor = m.last_status === 'up' ? '#34d399' : (m.last_status ? '#f87171' : '#fbbf24');
                var statusText = (m.last_status || 'pending').toUpperCase();
                return '<div class="liquid-glass liquid-glass-hover p-6" style="position:relative;z-index:1;">' +
                    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">' +
                    '<div style="display:flex;align-items:center;gap:12px;">' +
                    '<div style="width:12px;height:12px;border-radius:50%;background:' + statusColor + ';box-shadow:0 0 12px ' + statusColor + ';"></div>' +
                    '<h3 class="font-bold text-lg text-white">' + m.name + '</h3>' +
                    '</div>' +
                    '<span style="padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;background:' + statusColor + '30;color:' + statusColor + ';border:1px solid ' + statusColor + '50;">' + statusText + '</span>' +
                    '</div>' +
                    '<p style="color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:16px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + m.url + '</p>' +
                    '<div style="display:flex;gap:10px;">' +
                    '<a href="/monitors/' + m.id + '" class="liquid-btn" style="flex:1;text-align:center;padding:10px;text-decoration:none;"><span>View Details</span></a>' +
                    '<button onclick="window.deleteMonitor(' + m.id + ')" class="liquid-btn" style="padding:10px 16px;background:rgba(255,71,87,0.2);border-color:rgba(255,71,87,0.4);"><span style="color:#f87171;">Delete</span></button>' +
                    '</div>' +
                    '</div>';
            }).join('');
        });
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        var errorEl = document.getElementById('createError');
        errorEl.style.display = 'none';

        var name = document.getElementById('monitorName').value;
        var url = document.getElementById('monitorUrl').value;
        var timeout = parseInt(document.getElementById('monitorTimeout').value);

        apiCall('/api/monitors', {
            method: 'POST',
            body: JSON.stringify({name: name, url: url, timeout: timeout})
        }).then(function(response) {
            if (!response) return;
            if (response.ok) {
                closeModal();
                loadMonitors();
            } else {
                response.json().then(function(data) {
                    errorEl.textContent = data.detail || 'Error creating monitor';
                    errorEl.style.display = 'block';
                });
            }
        });
    });

    window.deleteMonitor = function(id) {
        if (!confirm('Delete this monitor? This action cannot be undone.')) return;
        apiCall('/api/monitors/' + id, {method: 'DELETE'}).then(function() {
            loadMonitors();
        });
    };

    loadMonitors();
    setInterval(loadMonitors, 30000);
})();
</script>
{% endblock %}
