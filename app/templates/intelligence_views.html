{% extends "base.html" %}
{% block title %}Smart Views{% endblock %}
{% block page_title %}Smart Views{% endblock %}
{% block content %}
<div id="upgradePrompt" class="card" style="text-align:center;padding:60px;">
    <div style="font-size:64px;margin-bottom:24px;">üëÅÔ∏è</div>
    <h1 style="font-size:32px;font-weight:700;color:#1a1a1a;margin-bottom:16px;">Fonctionnalit√© PRO</h1>
    <p style="color:#6b7280;font-size:18px;margin-bottom:32px;max-width:500px;margin-left:auto;margin-right:auto;">
        Les Smart Views sont une fonctionnalit√© PRO. Regroupez vos moniteurs automatiquement par statut : Critical, Unstable et Stable.
    </p>
    <div style="background:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%);border-radius:12px;padding:32px;margin-bottom:32px;">
        <h2 style="font-size:24px;font-weight:700;color:#fff;margin-bottom:16px;">D√©bloquez Smart Views PRO</h2>
        <ul style="list-style:none;padding:0;margin-bottom:24px;color:#fff;text-align:left;">
            <li style="margin-bottom:12px;">‚úì Groupement automatique</li>
            <li style="margin-bottom:12px;">‚úì Moniteurs Critical</li>
            <li style="margin-bottom:12px;">‚úì Moniteurs Unstable</li>
            <li style="margin-bottom:12px;">‚úì Moniteurs Stable</li>
            <li>‚úì Focus sur l'important</li>
        </ul>
        <a href="/upgrade" class="btn" style="background:#fff;color:#1e1b4b;font-weight:700;text-decoration:none;padding:16px 32px;border-radius:8px;display:inline-block;">
            Upgrade to PRO - ‚Ç¨19/mois
        </a>
    </div>
</div>

<div id="viewsContent" class="space-y-8 fade-in" style="display:none;">
    <div>
        <h1 style="font-size:28px;font-weight:700;color:#1a1a1a;margin-bottom:8px;">Smart Views</h1>
        <p style="color:#6b7280;">Automatic grouping of monitors by status: Critical, Unstable and Stable</p>
    </div>

    <!-- Critical Monitors -->
    <div>
        <h2 style="font-size:20px;font-weight:700;color:#ef4444;margin-bottom:16px;">üî¥ Critical Monitors</h2>
        <div id="critical" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;"></div>
        <div id="noCritical" style="display:none;padding:24px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;color:#991b1b;text-align:center;">No critical monitors</div>
    </div>

    <!-- Unstable Monitors -->
    <div>
        <h2 style="font-size:20px;font-weight:700;color:#f59e0b;margin-bottom:16px;">‚ö†Ô∏è Unstable Monitors</h2>
        <div id="unstable" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;"></div>
        <div id="noUnstable" style="display:none;padding:24px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;color:#92400e;text-align:center;">No unstable monitors</div>
    </div>

    <!-- Stable Monitors -->
    <div>
        <h2 style="font-size:20px;font-weight:700;color:#10b981;margin-bottom:16px;">‚úÖ Stable Monitors</h2>
        <div id="stable" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;"></div>
        <div id="noStable" style="display:none;padding:24px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;color:#166534;text-align:center;">No stable monitors</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var token = localStorage.getItem('token');
    if (!token) window.location.href = '/login';
    
    // Check user plan and show upgrade prompt if FREE
    fetchWithAuth('/api/settings/me').then(function(r) {
        if (!r) return;
        return r.json();
    }).then(function(user) {
        if (!user) return;
        
        var isFree = user.plan === 'FREE';
        var upgradePrompt = document.getElementById('upgradePrompt');
        var viewsContent = document.getElementById('viewsContent');
        
        if (isFree) {
            upgradePrompt.style.display = 'block';
            viewsContent.style.display = 'none';
        } else {
            upgradePrompt.style.display = 'none';
            viewsContent.style.display = 'block';
            
            function renderMonitor(m) {
                var statusColor = m.last_status === 'up' ? '#10b981' : '#ef4444';
                return '<div class="card">' +
                    '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">' +
                    '<div style="width:10px;height:10px;border-radius:50%;background:' + statusColor + ';"></div>' +
                    '<h3 style="font-size:14px;font-weight:600;color:#1a1a1a;">' + m.name + '</h3>' +
                    '</div>' +
                    '<p style="color:#6b7280;font-size:12px;">' + m.url + '</p>' +
                    '</div>';
            } 
        
            Promise.all([
                fetchWithAuth('/api/intelligence/monitors/views/critical').then(r => r ? r.json() : []),
                fetchWithAuth('/api/intelligence/monitors/views/unstable').then(r => r ? r.json() : []),
                fetchWithAuth('/api/intelligence/monitors/views/stable').then(r => r ? r.json() : [])
            ]).then(function([critical, unstable, stable]) {
                // Critical
                if (critical.length > 0) {
                    document.getElementById('critical').innerHTML = critical.map(renderMonitor).join('');
                } else {
                    document.getElementById('noCritical').style.display = 'block';
                } 
        
                // Unstable
                if (unstable.length > 0) {
                    document.getElementById('unstable').innerHTML = unstable.map(renderMonitor).join('');
                } else {
                    document.getElementById('noUnstable').style.display = 'block';
                } 
        
                // Stable
                if (stable.length > 0) {
                    document.getElementById('stable').innerHTML = stable.map(renderMonitor).join('');
                } else {
                    document.getElementById('noStable').style.display = 'block';
                }
            });
        }
    });
})();
</script>
{% endblock %}
