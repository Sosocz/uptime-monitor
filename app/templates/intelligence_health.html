{% extends "base.html" %}
{% block title %}Health Scores{% endblock %}
{% block page_title %}Health Scores{% endblock %}
{% block content %}
<div id="upgradePrompt" class="card" style="text-align:center;padding:60px;">
    <div style="font-size:64px;margin-bottom:24px;">ðŸŽ¯</div>
    <h1 style="font-size:32px;font-weight:700;color:#1a1a1a;margin-bottom:16px;">FonctionnalitÃ© PRO</h1>
    <p style="color:#6b7280;font-size:18px;margin-bottom:32px;max-width:500px;margin-left:auto;margin-right:auto;">
        Les Health Scores sont une fonctionnalitÃ© PRO. Voyez quels sites ont besoin d'attention avec des grades de A+ Ã  D.
    </p>
    <div style="background:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%);border-radius:12px;padding:32px;margin-bottom:32px;">
        <h2 style="font-size:24px;font-weight:700;color:#fff;margin-bottom:16px;">DÃ©bloquez Health Scores PRO</h2>
        <ul style="list-style:none;padding:0;margin-bottom:24px;color:#fff;text-align:left;">
            <li style="margin-bottom:12px;">âœ“ Grades de santÃ© A+ Ã  D</li>
            <li style="margin-bottom:12px;">âœ“ % de disponibilitÃ© en temps rÃ©el</li>
            <li style="margin-bottom:12px;">âœ“ Temps de rÃ©ponse moyen</li>
            <li style="margin-bottom:12px;">âœ“ Nombre d'incidents</li>
            <li>âœ“ Identification rapide des problÃ¨mes</li>
        </ul>
        <a href="/upgrade" class="btn" style="background:#fff;color:#1e1b4b;font-weight:700;text-decoration:none;padding:16px 32px;border-radius:8px;display:inline-block;">
            Upgrade to PRO - â‚¬19/mois
        </a>
    </div>
</div>

<div id="healthContent" class="space-y-8 fade-in" style="display:none;">
    <div>
        <h1 style="font-size:28px;font-weight:700;color:#1a1a1a;margin-bottom:8px;">Monitor Health Scores</h1>
        <p style="color:#6b7280;">Each monitor gets a health grade from A+ to D based on uptime, response time, and incident patterns</p>
    </div>

    <div id="monitors" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;"></div>
    <div id="noMonitors" class="card" style="text-align:center;padding:48px;display:none;">
        <p style="color:#6b7280;">No monitors found. Add monitors to see health scores.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var token = localStorage.getItem('token');
    if (!token) window.location.href = '/login';
    
    // Check user plan and show upgrade prompt if FREE
    fetchWithAuth('/api/settings/me').then(function(r) {
        if (!r) return;
        return r.json();
    }).then(function(user) {
        if (!user) return;
        
        var isFree = user.plan === 'FREE';
        var upgradePrompt = document.getElementById('upgradePrompt');
        var healthContent = document.getElementById('healthContent');
        
        if (isFree) {
            upgradePrompt.style.display = 'block';
            healthContent.style.display = 'none';
        } else {
            upgradePrompt.style.display = 'none';
            healthContent.style.display = 'block';
            
            // Load health scores (only for PRO)
            fetchWithAuth('/api/monitors').then(r => r ? r.json() : []).then(function(monitors) {
                if (!monitors || monitors.length === 0) {
                    document.getElementById('noMonitors').style.display = 'block';
                    return;
                } 
        
                var container = document.getElementById('monitors');
                var promises = monitors.map(function(m) {
                    return fetchWithAuth('/api/intelligence/monitors/' + m.id + '/health')
                        .then(r => r ? r.json() : null)
                        .then(health => ({ monitor: m, health: health }));
                });
        
                Promise.all(promises).then(function(results) {
                    container.innerHTML = results.map(function({monitor, health}) {
                        if (!health) return '';
                        var grade = health.health_grade || 'N/A';
                        var gradeColor = {'A+': '#10b981', 'A': '#10b981', 'B+': '#3b82f6', 'B': '#3b82f6', 'C': '#f59e0b', 'D': '#ef4444'}[grade] || '#6b7280';
                        return '<div class="card">' +
                            '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">' +
                            '<div><h3 style="font-size:16px;font-weight:600;color:#1a1a1a;">' + monitor.name + '</h3>' +
                            '<p style="color:#6b7280;font-size:13px;">' + monitor.url + '</p></div>' +
                            '<div style="font-size:32px;font-weight:800;color:' + gradeColor + ';">' + grade + '</div>' +
                            '</div>' +
                            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px;">' +
                            '<div><div style="color:#6b7280;">Health Score</div><div style="font-weight:600;">' + (health.health_score || 0).toFixed(1) + '%</div></div>' +
                            '<div><div style="color:#6b7280;">Uptime</div><div style="font-weight:600;">' + (health.uptime_pct || 0).toFixed(2) + '%</div></div>' +
                            '</div></div>';
                    }).join('');
                });
            });
        }
    });
})();
</script>
{% endblock %}
